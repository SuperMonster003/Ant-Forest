"use strict";let $_cvt=function(){function i(e,t){let{step:r,potential_step:o,units:i,init_unit:n,space:s,fixed:a}=t||{},l="string"==typeof e?Number(e.split(/,\s*/).join("")):Number(e),c=[];i.forEach(e=>{"string"==typeof e&&e.match(/\w+\|\w+/)?e.split("|").reverse().forEach((e,t)=>{t?c.push(1,e):c.push(e)}):c.push(e)});let u={};u[c[0]]=[1,1];let p=1,f;for(let t=1,e=c.length;t<e;t+=1){f=o?p:0;let e=c[t];var d;"number"==typeof e?(f=p*(o||e),p*=e,e=c[++t]):Array.isArray(e)?(d=e.sort((e,t)=>e<t?1:-1),f=p*d[1],p*=d[0],e=c[++t]):(f=p*(o||r),p*=r),e.split("|").forEach(e=>u[e]=f?[p,f]:[p,p])}e=n||c[0],~c.indexOf(e)&&(l*=u[e][0]);let h="";return Object.keys(u).reverse().some(t=>{var[r,e]=u[t];if(l>=e){let e=Number((l/r).toFixed(12));"number"==typeof a?e=~a?e.toFixed(a):e:1e3*e>>0!=1e3*e&&(e=e.toFixed(2));r=s?!0===s?" ":s:"";return h=Number(e)+r+t}}),h}return i.bytes=function(e,t,r){return o=t,t=r,r={step:1024,potential_step:1e3,units:["B","KB","MB","GB","TB","PB","EB","ZB","YB"]},i(e,Object.assign(void 0===o?{}:{init_unit:o},r||{},t||{}));var o},i.date=function(e,t){var r=e=>("0"+e).slice(-2);let o=function(t){if(t instanceof Date)return t;if("number"==typeof t)return new Date(t);if("string"!=typeof t)return new Date;{t.match(/^\d+$/)&&(8===t.length?t=t.replace(/\d{2}/g,"$&%").split("%").slice(0,-1).map((e,t)=>1<t?"/"+e:e).join(""):12===t.length?t=t.replace(/\d{2}/g,"$&%").split("%").slice(0,-1).map((e,t)=>0===t?(new Date).getFullYear().toString().slice(0,2)+e:t<3?"/"+e:3===t?" "+e:t<6?":"+e:e).join(""):14===t.length&&(t=t.replace(/\d{2}/g,"$&%").split("%").slice(0,-1).map((e,t)=>1<t&&t<4?"/"+e:4===t?" "+e:4<t&&t<7?":"+e:e).join("")));let e=new Date(t);if("Invalid Date"===e.toString())throw Error("Invalid Date");return e}}(e||new Date),i=o.getFullYear();var n=i.toString().slice(-2),s=o.getMonth()+1,a=r(s),l=o.getDate(),c=r(l),u=o.getHours(),p=r(u),f=o.getMinutes(),d=r(f),e=o.getSeconds(),r=r(e),h={yyyy:i,yy:n,MM:a,M:s,dd:c,d:l,hh:p,h:u,mm:d,m:f,ss:r,s:e};return function(e){let t=e.toString(),r="";for(;t.length;){let e=4;for(;e;){var o=t.slice(0,e);if(o in h){r+=h[o],t=t.slice(e);break}--e}e||(r+=t[0],t=t.slice(1))}return r}(t||"yyyy/MM/dd hh:mm:ss")},i}(),$appx={_project_structure:[{name:"/documents"},{name:"/modules",necessary:!0},{name:"/tools"},{name:"ant-forest-launcher.js",necessary:!0},{name:"ant-forest-settings.js",necessary:!0},{name:".gitignore"},{name:"jsconfig.json"},{name:"project.json",necessary:!0},{name:"LICENSE"},{name:"README.md"}],_project_step:{download:"下载数据包",decompress:"解压缩",backup:"备份本地项目",files_check:"检查文件",files_update:"项目文件替换",files_ready:"项目文件就绪",finish_deploy:"清理并完成部署",finish_restore:"清理并完成项目恢复"},deployProject:function(e,t,r){var n=this,o=r||{},i=t||{};let s=i.onDeployStart||i.onStart||(e=>e),a=i.onDeploySuccess||i.onSuccess||(e=>e),l=i.onDeployFailure||i.onFailure||console.error;if(null==e)throw Error("A version for appx.deployProject() must be defined");if("object"!=typeof e)throw Error("Cannot parse version for appx.deployProject()");let c=e.zipball_url;var r=c.slice(c.lastIndexOf("/")+1)+".zip",u=(t=java.io.File.separator,i=files.getSdcardPath()+"/.local/bak/ant-forest",files.exists(i)||files.createWithDirs(i+t),new java.io.File(i).getAbsolutePath())+java.io.File.separator+r;let p=-1;$httpx.getContentLength(c,function(e){f.setStepDesc(1,"  [ "+$_cvt.bytes(p=e,"B",{fixed:1,space:!0})+" ]",!0)},{timeout:15e3,concurrence:15});r=o.is_hide_title_version?"":" "+e.version_name,e=this._project_step;let f=$dialogsx.buildFlow({title:"正在部署项目"+r,success_title:o.success_title||"部署完成",on_interrupt_btn_text:o.on_interrupt_btn_text||"B",show_min_max:!0,onStart:(e,t)=>{s(),$dialogsx.setProgressColorTheme(t,"download")},onSuccess:(e,t)=>a(e,t),onFailure:(e,t)=>{l(e,t),t.setFailureData(e)},steps:[{desc:e.download,action:(e,n)=>new Promise((t,r)=>{let o=null,i=null;$httpx.okhttp3Request(c,u,{onStart:function(){let e=p/1024;var t=e<0?"":"0KB/"+e.toFixed(1)+"KB";$dialogsx.setProgressNumberFormat(n,t)},onDownloadProgress:function(e){var t=e.processed/1024;e.total=Math.max(e.total,p);var r=e.total/1024;$dialogsx.setProgressNumberFormat(n,"%.1fKB/%.1fKB",[t,r]),n.setProgressData(e)},onDownloadSuccess:function(e){$dialogsx.clearProgressNumberFormat(n),t(o=e)},onDownloadFailure:function(e){r(i=e)}},{is_async:!0}),$threadsx.start(function(){_waitForAction(()=>o||i,0,120),o&&t(o),i&&r(i)})})},{desc:e.decompress,action:(i,t)=>new Promise((r,o)=>{$filesx.unzip(i.downloaded_path,null,{onUnzipProgress:e=>t.setProgressData(e),onUnzipSuccess:function(e){let t=e.unzipped_path;n.isProjectLike(t)||(t+=java.io.File.separator+files.listDir(t)[0]),n.isProjectLike(t)||o("Cannot locate project path in unzipped files"),r(Object.assign(i,{unzipped_files_path:e.unzipped_path,unzipped_proj_path:t}))},onUnzipFailure:e=>o(e)},{to_archive_name_folder:!0,is_delete_source:!0})})},{desc:e.backup,action:(o,i)=>new Promise((t,r)=>{if(!n.getProjectLocalPath())return i.setStepDesc(3,"  [ 跳过 ]",!0),t(o);n.backupProject({onBackupProgress:e=>i.setProgressData(e),onBackupSuccess:e=>t(Object.assign(o,{backup:e})),onBackupFailure:e=>r(e)},{remark:"版本升级前的自动备份",is_save_storage:!0})})},{desc:e.files_update,action:(o,i)=>new Promise((e,t)=>{var r=n.getProjectLocalPath(!0);$filesx.copy(o.unzipped_proj_path,r,{is_unbundled:!0},{onCopyProgress:e=>i.setProgressData(e),onCopySuccess:()=>e(Object.assign(o,{tar_proj_path:r})),onCopyFailure:e=>t(e)})})},{desc:e.finish_deploy,action:(r,o)=>new Promise((e,t)=>{$filesx.deleteByList(r.unzipped_files_path,{is_async:!0},{onDeleteProgress:e=>o.setProgressData(e),onDeleteSuccess:()=>e({target_path:r.tar_proj_path}),onDeleteFailure:e=>t(e)})})}]}).act()},getProjectLocal:function(){let e="",t=-1;var r=this.getProjectLocalPath();if(!r)throw Error("Cannot locate project path for appx.getProjectLocal()");var o,i=r+"/project.json";let n=r+"/ant-forest-launcher.js";try{files.exists(i)?(o=JSON.parse(files.read(i)),n=o.main,e="v"+o.versionName,t=Number(o.versionCode)):e="v"+files.read(n).match(/version (\d+\.?)+( ?(Alpha|Beta)(\d+)?)?/)[0].slice(8)}catch(e){console.warn(e.message),console.warn(e.stack)}return{version_name:e,version_code:t,main:n,path:r}},getProjectReleases:function(c,e){if("function"!=typeof e)return t();function t(){let e=[];var t=c||{};let r=null;delete global._$_get_proj_releases_interrupted,t.show_progress_dialog&&($dialogsx.setProgressColorTheme(r=$dialogsx.build({content:"正在获取版本信息...",progress:{max:-1,showMinMax:!1,horizontal:!0},positive:"I"}).on("positive",e=>{e.dismiss(),global._$_get_proj_releases_interrupted=!0}).show(),"indeterminate"),$dialogsx.disableBack(r));var o=t.max_items||1/0;let i=1;var n=t.per_page||30,s=t.min_version_name||"v0.0.0";let a=3;for(;a--;)try{var l=http.get("https://api.github.com/repos/SuperMonster003/Ant-Forest/releases?per_page="+n+"&page="+i++).body.json().filter(e=>e.tag_name>=s);if(global._$_get_proj_releases_interrupted)return[];if(e=e.concat(l),l.length<n||e.length>=o)break}catch(e){sleep(120+240*Math.random())}return a<0?(r&&(r.dismiss(),$dialogsx.builds(["失败","版本信息获取失败",0,0,"X",1]).on("positive",e=>e.dismiss()).show()),[]):(e.splice(o),r&&(r.dismiss(),r=null),t.no_extend?e:e.map(function(o){let i={name:"标题",tag_name:"标签",body:"内容描述"},e=$_cvt.date(new Date(o.published_at),"yyyy/MM/dd hh:mm:ss");e?(o.locale_published_at=e,i.locale_published_at="发布"):i.published_at="发布";return o.version_name=o.tag_name,o.brief_info_str=Object.keys(i).map(e=>{let t=o[e];if(t){var r=i[e];return"body"===e&&(t="\n"+t),r+": "+t}return""}).filter(e=>!!e).join("\n\n"),o}))}$threadsx.start(function(){e(t())})},getProjectChangelog:function(e,t,r){let o=this,s=Math.trunc(Number(e.toString().match(/\d+/)[0])),a=t||{};r=r||{};let l=r.onStart||(e=>e),c=r.onSuccess||(e=>e),u=r.onFailure||console.error,p=null;if(!a.is_show_dialog)return f();let i=null,n=e=>e;function f(){l();let e=function(){let a=5;for(;a--;)try{return function(e){let t=new java.net.URL(e),r=t.openConnection();r.setRequestMethod("GET"),r.setConnectTimeout(15e3),r.setReadTimeout(15e3),r.connect();e=r.getResponseCode();if(e!==java.net.HttpURLConnection.HTTP_OK){a||u("请求失败: "+e);try{r.disconnect()}catch(e){}return null}let o=r.getInputStream(),i=new java.io.BufferedReader(new java.io.InputStreamReader(o)),n=new java.lang.StringBuilder,s=null;for(;null!==(s=i.readLine());)n.append(s).append("\r\n");return[r,i,o].forEach(e=>{try{e.close()}catch(e){}}),n.toString()}("https://github.com/SuperMonster003/Ant-Forest/blob/master/documents/CHANGELOG-"+s+".md").match(/版本历史[^]+article/)[0].replace(/<path .+?\/path>/g,"").replace(/<a .+?(<code>((issue |pr )?#\d+)<\/code>)?<\/a>/g,(e,t,r)=>r?"_[`"+r+"`]_":"").replace(/<svg .+?\/svg>/g,"").replace(/<link>.+/g,"").replace(/<h1>/g,"# ").replace(/<h6>/g,"###### ").replace(/<\/?(li|ul|del|em|h\d)>/g,"").replace(/<code>/g,"* `").replace(/<\/code>/g,"`").replace(/\s*<\/articl.*/,"")}catch(e){}return null}();if(!e){var t="获取历史更新信息失败";return p?p.setContent(t):u(t),a.is_joint?"":[]}var t=/# v\d+\.\d+\.\d+.*/g,r=new RegExp(/^(\s*\n\s*)+/.source+"|"+/(# *){3,}/.source+"|"+/ +(?=\s+)/.source+"|"+/.*~~.*/.source+"|"+/.*`灵感`.*/.source+"|"+/\(http.+?\)/.source+"|"+/\[\/\/]:.+\(\n*.+?\n*\)/.source+"|"+/\s*<br>/.source,"g");let o=e.match(t),i=e.split(t),n=o.map((e,t)=>({ver:"v"+e.split("v")[1],log:i[t+1].replace(/ ?_\[`(issue |pr )?#(\d+)`](\(http.+?\))?_ ?/g,"[$2]").replace(r,"").replace(/(\[\d+])+/g,e=>" "+e.split(/\[]/).join(",").replace(/\d+/g,"#$&")).replace(/(\s*\n\s*){2,}/g,"\n")}));if(c(n),!p&&!a.is_joint)return n;t=n.map(e=>e.ver+"\n"+e.log).join("\n").slice(0,-1);return p&&p.setContent(t),a.is_joint?t:void 0}!a.no_earlier&&1<s&&(i="更早期的历史",n=function(){$dialogsx.builds(["选择一个历史版本记录","",0,0,"B",1],{items:(()=>{let t=[];for(let e=1;e<s;e+=1)t.push("v"+e+".x");return t})()}).on("positive",$dialogsx.dismiss).on("item_select",e=>{o.getProjectChangelog(e+1,{is_show_dialog:!0,no_earlier:!0})}).show()}),p=$dialogsx.builds(["历史更新","处理中...",[i,"hint"]," ","B",1]).on("neutral",n).on("positive",$dialogsx.dismiss).show(),$threadsx.start(f)},isProjectLike:function(e,t){var r=files.path(e);if(!files.exists(r)){if(t)throw Error('Passed "dir" is not exist');return!1}if(!files.isDir(r)){if(t)throw Error('Passed "dir" is not a directory');return!1}let o=files.listDir(r=new java.io.File(r).getAbsolutePath());return this._project_structure.filter(e=>e.necessary).map(e=>"/"===e.name[0]?{name:e.name.slice(1),is_dir:!0}:{name:e.name}).every(e=>{if(~o.indexOf(e.name)){var t=e.is_dir,e=files.isDir(r+java.io.File.separator+e.name);return t&&e||!t&&!e}})},getProjectLocalPath:function(e){let t=files.cwd();if(this.isProjectLike(t))return t;if(t=new java.io.File(t).getParent(),this.isProjectLike(t))return t;var r=$filesx.getScriptDirPath(),o=java.io.File.separator,r=r+o+"Ant-Forest-003";return files.isDir(r)?r:e?(files.createWithDirs(r+o),r):""},backupProject:function(e,t){let n=this,o=java.io.File.separator,s=e||{},a=t||{},l=Date.now(),c=n.getProjectLocalVerName();var r=n.getVerHex(c);let u=(e=java.io.File.separator,t=files.getSdcardPath()+"/.local/bak/ant-forest",files.exists(t)||files.createWithDirs(t+e),new java.io.File(t).getAbsolutePath());r=$_cvt.date(l,"yyMMddhhmmss")+"-"+r+".zip";let p=u+o+r;return a.is_show_dialog?$dialogsx.buildProgress({show_min_max:!0,title:"正在备份",content:"此过程可能需要一些时间",success_title:"备份完成",onStart:(e,t)=>$dialogsx.setProgressColorTheme(t,"backup"),action:function(e,o){return i({onProgress:function(e){var t=e.processed/1024,r=e.total/1024;$dialogsx.setProgressNumberFormat(o,"%.1fKB/%.1fKB",[t,r]),o.setProgressData(e)},onSuccess:function(e){$dialogsx.setContentText(o,"版本: "+e.version_name+"\n路径: "+e.path+"\n备注: "+e.remark)}})}}).act():i();function i(e){let i=e||{};return $filesx.zip(function(){var e=u+o+"."+l+o;files.createWithDirs(e);let t=function(){let e=a.source_path;e&&"cwd"!==e&&"current"!==e||(e=files.cwd());if(!files.isDir(e))throw Error("source_path for appx.backupProject must be a directory");if(n.isProjectLike(e))return e;if(e=new java.io.File(e).getParent(),n.isProjectLike(e))return e;var t=$filesx.getScriptDirPath(),r=java.io.File.separator;if(e=t+r+"Ant-Forest-003",n.isProjectLike(e))return e;throw Error("Unable to locate Ant-Forest project folder")}(),r=n._project_structure.map(e=>e.name.replace(/^\//,""));return $filesx.copy(t,e,{is_unbundled:!0,filter:function(e){return!!~r.indexOf(e)}}),e}(),p,{onZipStart:function(){"function"==typeof i.onStart&&i.onStart();let e=s.onBackupStart||s.onStart;"function"==typeof e&&e.call(s)},onZipProgress:function(e){"function"==typeof i.onProgress&&i.onProgress(e);let t=s.onBackupProgress||s.onProgress;"function"==typeof t&&t.call(s,e)},onZipSuccess:function(){var r={path:p,timestamp:l,version_name:c,remark:a.remark||"手动备份"};"function"==typeof i.onSuccess&&i.onSuccess(r);let e=s.onBackupSuccess||s.onSuccess;if("function"==typeof e&&e.call(s,r),a.is_save_storage){var o=n.getProjectLocalPath(),o=files.path(o+"/modules/mod-storage.js");if(!files.exists(o))throw Error("Module mod-storage doesn't exist");let e=require(o).create("af_bak"),t=e.get("project",[]);e.put("project",t.concat(r))}},onZipFailure:function(e){"function"==typeof i.onFailure&&i.onFailure(e);let t=s.onBackupFailure||s.onFailure;"function"==typeof t&&t.call(s,e)}},{is_exclude_root_folder:!0,is_delete_source:!0})}},getProjectLocalVerName:function(){return this.getProjectLocal().version_name},getVerHex:function(e,t){if(!(e="object"==typeof e?e.version_name:e))throw Error('A "version" must be defined for appx.getVerHex()');var r=t||{},a=e=>("00"+Number(e).toString(16)).slice(-2),t=e.trim().replace(/^v?(\d+)\.(\d+)\.(\d+)\s*(a(?:lpha)?|b(?:eta)?)?\s*(\d*)$/i,(e,t,r,o,i,n)=>{o=[t,r,o].map(e=>a(e)).reduce((e,t)=>e+t),n=n?Number(n):1;let s=255;if(i)if(i.match(/a(lpha)?/i)){if(128<n)throw Error("Alpha version code cannot be greater than 128");s=0}else if(i.match(/b(eta)?/i)){if(127<=n)throw Error("Alpha version code must be smaller than 127");s=128}return o+a(Math.min(s+n,255))}),e="0x"+t;return"number"===r.type?Number(e):"string_with_prefix"===r.type?e:t},getProjectNewestRelease:function(e,t){let r=this;if("function"!=typeof t)return o();function o(){return r.getProjectReleases(Object.assign(e||{},{max_items:1,per_page:1}))[0]}$threadsx.start(function(){t(o())})}},$httpx={getContentLength:function(r,o,e){if("string"!=typeof r)throw Error("url for $httpx.getContentLength() is required");if("function"!=typeof o)throw Error("callback for $httpx.getContentLength() is required");var e=e||{},i=e.timeout||1e4,n=Date.now()+i;let s=threads.atomic(-1);var t=e.concurrence||12;for(let e=0;e<t;e+=1)!function(e){let t=$threadsx.start(function(){try{let e=new java.net.URL(r).openConnection();e.setRequestProperty("Accept-Encoding","identity"),e.setConnectTimeout(i);var t=e.getContentLengthLong();e.disconnect(),~t&&s.compareAndSet(-1,t)&&o(s.get())}catch(e){}});$threadsx.start(function(){for(;;){if(0<s.get())return t.interrupt();if(Date.now()>=n)return e(-1),t.interrupt();sleep(120)}})}()},okhttp3Request:function(a,e,t,r){let l,c,u,p;var f=files.path(e);let o=t||{};var d=r||{};let h=o.onStart||(e=>e),g=o.onResponse||(e=>e),m=o.onDownloadProgress||(e=>e),_=o.onDownloadSuccess||(e=>e);var v=e=>{if("function"!=typeof o.onDownloadFailure)throw Error(e);o.onDownloadFailure(e)};if(!a)return v("url for $httpx.okhttp3Request() is required");function i(){try{h();let t=new Packages.okhttp3.Request.Builder;Object.keys(d.headers||{}).forEach(e=>{t.addHeader(e,d.headers[e])});let e=(new OkHttpClient).newCall(t.url(a).get().build()).execute();g(e);var i=java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE,4096);let r,o=0;var n=e.code();200!==n&&v(n+" "+e.message()),l=e.body().byteStream(),u=new java.io.BufferedInputStream(l),c=new java.io.FileOutputStream(new java.io.File(f)),p=new java.io.BufferedOutputStream(c);for(var s=e.body().contentLength();~(r=u.read(i,0,4096));)global._$_dialog_flow_interrupted&&(x(),v("用户终止")),c.write(i,0,r),o+=r,m({processed:o,total:s});x(),_({downloaded_path:f})}catch(e){v("请求失败:\n"+e)}}function x(){[p,c,u,l].forEach(e=>{try{e&&e.close()}catch(e){}}),global._$_dialog_flow_interrupted=!1}void 0===d.is_async||d.is_async?$threadsx.start(i):i()}},$filesx={_files$copy:function(e,t,r){var a=files.path(e),o=files.path(t),r=r||{};let i=r.onCopyStart||r.onStart||(e=>e),l=r.onCopyProgress||r.onProgress||(e=>e),c=r.onCopySuccess||r.onSuccess||(e=>e),u=r.onCopyFailure||r.onFailure||console.error;try{return function(e,t){i(),files.createWithDirs(t);var r=new java.io.File(t);try{var o=new java.io.FileOutputStream(r);return function(e,t,r){let o=util.java.array("byte",8192),i=new java.io.File(a).length(),n=0;try{for(;0<e.available();){var s=e.read(o);0<s&&(t.write(o,0,s),l({processed:n+=s,total:i}))}r&&(e.close(),t.close()),c()}catch(e){u(e)}}(e,o,!0),!0}catch(e){return u(e),!1}}(new java.io.FileInputStream(a),o)}catch(e){return u(e),!1}},getScriptDirPath:function(){return org.autojs.autojs.Pref.getScriptDirPath()},unzip:function(e,t,r,o){let n,s,a;function l(){global._$_dialog_flow_interrupted=!1,[s,n,a].forEach(e=>{try{e&&e.close()}catch(e){}})}var c=r||{},u=e=>{let t=c.onUnzipFailure||c.onFailure;return("function"==typeof t?t:toastLog)(e),!1};let i=c.onUnzipStart||c.onStart;"function"==typeof i&&i();var p=java.io.File.separator,f=o||{};let d=files.path(e);if(files.exists(d)||(d+=".zip"),!files.exists(d))throw Error("解压缩源不存在");let h=new java.io.File(d);var g=h.length();let m=h.getName();e=m.slice(0,m.lastIndexOf("."));let _=files.path(t);_&&files.exists(_)||(_=d.slice(0,d.lastIndexOf(p))),f.to_archive_name_folder&&(_+=p+e),files.createWithDirs(_+p);try{let o=0;var v=util.java.array("byte",1024);let i=new java.util.zip.ZipFile(h),e=i.entries();for(;e.hasMoreElements();){let t=e.nextElement();var x=t.getCompressedSize(),b=t.getName(),b=files.path(_+p+b);files.createWithDirs(b);let r=new java.io.File(b);if(!r.isDirectory()){var w;for(n=new java.io.FileOutputStream(r),s=new java.io.BufferedOutputStream(n),a=new java.io.BufferedInputStream(i.getInputStream(t));~(w=a.read(v,0,1024));){if(global._$_dialog_flow_interrupted)return l(),u("用户终止");n.write(v,0,w)}let e=c.onUnzipProgress||c.onProgress;"function"==typeof e&&e({processed:o+=x,total:g})}}l();let t=c.onUnzipSuccess||c.onSuccess;return"function"==typeof t&&t({unzipped_path:_}),f.is_delete_source&&this.removeWithDirs(d,{is_async:!0}),!0}catch(e){return u("解压失败:\n"+e)}},removeWithDirs:function(o,e,t){var r=e||{},t=t||{};let i=t.onRemoveStart||t.onStart||(e=>e),n=t.onRemoveProgress||t.onProgress||(e=>e),s=t.onRemoveSuccess||t.onSuccess||(e=>e),a=t.onRemoveFailure||t.onFailure||console.error,l=0,c=1;try{return r.is_async?$threadsx.start(u):u()}catch(e){a(e)}function u(){let t=!0;if(i(),files.isFile(o))t=p(o);else{if(!files.isDir(o))throw Error("Cannot parse path for $filesx.removeWithDirs()");{let e=files.listDir(o);var r=java.io.File.separator;c=e.length,e.forEach(e=>{t=p(o+r+e)&&t}),files.remove(o)}}return t&&s(),t||a("An error has occurred in files.removeWithDirs()"),t}function p(e){e=files.isDir(e)?files.removeDir(e):!!files.isFile(e)&&files.remove(e);return n({progress:l+=1,total:c}),e}},deleteByList:function(i,e,t){let n=this;e=e||{},t=t||{};let s=t.onDeleteStart||t.onStart||(e=>e),a=t.onDeleteProgress||t.onProgress||(e=>e),l=t.onDeleteSuccess||t.onSuccess||(e=>e),c=t.onDeleteFailure||t.onFailure||console.error;if(e.is_async)return r();function r(){s();let t=!0,e=n.listAllFiles(i).reverse(),r=0;var o=e.length;return e.forEach(e=>{t=e.delete()&&t,a({processed:r+=1,total:o})}),t&&l(),t||c("An error has occurred in files.deleteByList()"),t}$threadsx.start(r)},listAllFiles:function(e){let r=[];return function e(t){t.isFile()?r.push(t):t.isDirectory()&&(r.push(t),t.listFiles().forEach(e))}(e="string"==typeof e?new java.io.File(files.path(e)):e),r},zip:function(e,t,r,o){let n,s,i,a,l,c=function(){global._$_dialog_flow_interrupted=!1,[l,a,i,s,n].forEach(e=>{try{e&&e.close()}catch(e){}})};let u=r||{},p=o||{},f=e=>{let t=u.onZipFailure||u.onFailure;return("function"==typeof t?t:toastLog)(e),!1},d=u.onZipStart||u.onStart;"function"==typeof d&&d();var h,g=files.path(e);if(!files.exists(g))throw Error("无效的压缩源");let m=new java.io.File(g);g=m.getAbsolutePath();let _=t?files.path(t):g+".zip",v=new java.io.File(_);_=v.getAbsolutePath(),"zip"!==files.getExtension(_)&&(v=new java.io.File(_+=".zip")),files.exists(_)&&files.remove(_);let x=0,b=this.getDirSize(g);try{i=new java.io.FileOutputStream(v),a=new java.util.zip.CheckedOutputStream(i,new java.util.zip.CRC32),l=new java.util.zip.ZipOutputStream(a),h=m,p.is_exclude_root_folder&&h.isDirectory()?h.listFiles().filter(e=>e.getAbsolutePath()!==v.getAbsolutePath()).forEach(e=>w(e)):w(h),c();let e=u.onZipSuccess||u.onSuccess;return"function"==typeof e&&e({zipped_path:_}),p.is_delete_source&&this.removeWithDirs(g,{is_async:!0}),!0}catch(e){return f("压缩失败:\n"+e)}function w(r,e){var o=(e?e+java.io.File.separator:"")+r.getName();if(r.isFile()){let e;var i=util.java.array("byte",1024);for(l.putNextEntry(new java.util.zip.ZipEntry(o)),n=new java.io.FileInputStream(r),s=new java.io.BufferedInputStream(n);~(e=s.read(i,0,1024));){if(global._$_dialog_flow_interrupted)return c(),f("用户终止");l.write(i,0,e)}l.closeEntry(),s.close(),n.close();let t=u.onZipProgress||u.onProgress;"function"==typeof t&&t({processed:x+=r.length(),total:b})}else r.listFiles().filter(e=>e.getAbsolutePath()!==v.getAbsolutePath()).forEach(e=>w(e,o))}},copy:function(e,t,r,o){o=o||{};let a=o.onCopyStart||o.onStart||(e=>e),l=o.onCopyProgress||o.onProgress||(e=>e),c=o.onCopySuccess||o.onSuccess||(e=>e),u=o.onCopyFailure||o.onFailure||console.error;e&&t||u("Source and target path must be both defined"),files.isDir(t)||u("Target path must be a directory");let p=this,f=java.io.File.separator,d=new java.io.File(files.path(e)).getAbsolutePath(),h=new java.io.File(files.path(t)).getAbsolutePath();r=r||{};let g=r.is_unbundled,m=r.filter||function(){return!0};if(!r.is_async)return i();function i(){"function"==typeof a&&a();let o=!0,i=0,n=1;if(files.isDir(d)){g||(h+=f+files.getName(d));let e=files.listDir(d,m);n=e.length,e.forEach(e=>s(d+f+e,h))}else s(d,h);return o&&c(),o||u("An error has occurred in files.copy()"),o;function s(t,e){var r=e+f+files.getName(t);files.isFile(t)?(p._files$copy(t,r)||(o=!1),l({processed:i+=1,total:n})):files.listDir(t).forEach(e=>{s(t+f+e,r)})}}$threadsx.start(i)},getDirSize:function(e){e=files.path(e);if(!files.exists(e))throw Error("path of filesx.getDirSize() is not exist");return files.isFile(e)?new java.io.File(e).length():new java.io.File(e).listFiles().reduce((e,t)=>e+(t.isDirectory()?this.getDirSize(t):t.length()),0)}},$colorsx={toInt:function(t){let e;try{e="string"==typeof t?colors.parseColor(t):t}catch(e){throw console.error("Passed color: "+t),Error(e)}if("number"!=typeof e)throw TypeError("Unknown type of color for $colorsx.toInt()");return e}},$threadsx={start:function(e,t){try{return threads.start(e)}catch(e){var r=/(Script)?InterruptedEx|script exiting/;if(!e.message.match(r)&&!t)throw Error(e)}}},$dialogsx={_colors:{wrap:function(e,t){if(t&&this[t])for(var r in this[t])if(this[t].hasOwnProperty(r)&&e===r){var o=this[t][r];return Array.isArray(o)?o[0]:o}return e},title:{default:"#212121",caution:"#880e4f",alert:["#c51162","#ffeffe"]},content:{default:"#757575",warn:"#ad1457",alert:["#283593","#e1f5fe"]},progress:{download:["#ff6f00","#ffecb3","#c43e00"],files:["#f9a825","#fff59d","#c17900"],backup:["#455a64","#eceff1","#1c313a"],restore:["#ab47bc","#f3e5f5","#790e8b"],indeterminate:["#00897b","#b2dfdb","#005b4f"],finish:["#00c853","#dcedc8","#009624"],success:["#00c853","#dcedc8","#009624"],error:["#1565c0","#bbdefb","#003c8f"],failure:["#1565c0","#bbdefb","#003c8f"]},button:{default_aj_4:"#01a9f3",default:"#03a9f4",caution:"#ff3d00",warn:"#f57c00",attraction:"#7b1fa2",hint:"#0da798",reset:"#a1887f",unavailable:"#bdbdbd",finish:"#009624",success:"#009624",error:"#003c8f",failure:"#003c8f"}},_text:{_btn:{F:"完成",B:"返回",Q:"放弃",X:"退出",I:"终止",K:"确定",S:"确认",C:"关闭",D:"删除",N:"继续",M:"确认修改",R:"设为默认值"},no_more_prompt:"不再提示",user_interrupted:"用户终止"},build:function(t){let r=this,o=Object.create(runtime.dialogs.newBuilder());return o.thread=threads.currentThread(),Object.keys(t).forEach(e=>function(t,r,o){let i={title:null,titleColor:{adapter:$colorsx.toInt},buttonRippleColor:{adapter:$colorsx.toInt},icon:null,content:null,contentColor:{adapter:$colorsx.toInt},contentLineSpacing:null,items:null,itemsColor:{adapter:$colorsx.toInt},positive:{method:"positiveText",adapter:n},positiveColor:{adapter:$colorsx.toInt},neutral:{method:"neutralText",adapter:n},neutralColor:{adapter:$colorsx.toInt},negative:{method:"negativeText",adapter:n},negativeColor:{adapter:$colorsx.toInt},cancelable:null,canceledOnTouchOutside:null,autoDismiss:null};if(i.hasOwnProperty(r)){let e=i[r]||{};void 0===e.method&&(e.method=r),e.adapter&&(o=e.adapter(o)),t[e.method].call(t,o)}}(o,e,t[e])),function(i,t){if(void 0===t.inputHint&&void 0===t.inputPrefill||i.input(r(t.inputHint),r(t.inputPrefill),function(e,t){return i.emit("input_change",i.dialog,t.toString())}).alwaysCallInputCallback(),void 0!==t.items){var e=t.itemsSelectMode;if(void 0===e||"select"===e)i.itemsCallback(function(e,t,r,o){i.emit("item_select",r,o.toString(),i.dialog)});else if("single"===e)i.itemsCallbackSingleChoice(void 0===t.itemsSelectedIndex?-1:t.itemsSelectedIndex,function(e,t,r,o){return i.emit("single_choice",r,o.toString(),i.dialog),!0});else{if("multi"!==e)throw new Error("Unknown itemsSelectMode "+e);i.itemsCallbackMultiChoice(void 0===t.itemsSelectedIndex?null:t.itemsSelectedIndex,function(e,t,r){return i.emit("multi_choice",o(t,(e,t)=>parseInt(e[t])),o(r,(e,t)=>e[t].toString()),i.dialog),!0})}}if(void 0!==t.progress&&(e=t.progress,i.progress(-1===e.max,e.max,!!e.showMinMax),i.progressIndeterminateStyle(!!e.horizontal)),void 0===t.checkBoxPrompt&&void 0===t.checkBoxChecked||i.checkBoxPrompt(r(t.checkBoxPrompt),!!t.checkBoxChecked,function(e,t){return i.getDialog().emit("check",t,i.getDialog())}),void 0!==t.customView){let e=t.customView;"xml"!=typeof e&&"string"!=typeof e||(e=ui.run(()=>ui.inflate(e)));t=t.wrapInScrollView;i.customView(e,void 0===t||t)}function r(e){return e||""}function o(t,r){let o=[];var i=t.length;for(let e=0;e<i;e++)o.push(r(t,e));return o}}(o,t),ui.run(o.buildDialog.bind(o));function n(e){return r._text._btn[e]||e}},builds:function(e,t){let[r,o,i,n,s,a,l]="string"==typeof e?[e]:e,c={autoDismiss:!a,canceledOnTouchOutside:!a,checkBoxPrompt:l?"string"==typeof l?l:this._text.no_more_prompt:void 0};return[["title",r,this._colors.title],["content",o,this._colors.content],["neutral",i,this._colors.button,this._text._btn],["negative",n,this._colors.button,this._text._btn],["positive",s,this._colors.button,this._text._btn]].forEach(e=>function(e,t,r,o){var[i,t]=Array.isArray(t)?t:[t];i&&(c[e]=o&&o[i]||i);c[e+"Color"]=r[t]||t||r.default}.apply(null,e)),this.build(Object.assign(c,t))},getContentText:function(e){return e?e.getContentView().getText().toString():null},appendContentText:function(e,t){ui.run(()=>{e&&e.getContentView().setText(this.getContentText(e)+(t?t.toString():""))})},linkify:function(e,r){if(e){let t=e.getContentView();ui.run(()=>{var e=t.getText().toString();t.setAutoLinkMask(android.text.util.Linkify[r||"ALL"]),t.setText(e)})}},setTitleText:function(e,t){ui.run(()=>{e&&e.getTitleView().setText(t?t.toString():"")})},alertContent:function(e,t,r){let o=e.getContentView();var i=o.getText().toString(),n="append"===r||!0===r,[s,a]=this._colors.content.alert.map($colorsx.toInt);ui.post(()=>{o.setText((n?i+"\n\n":"")+t),o.setTextColor(s),o.setBackgroundColor(a)})},buildFlow:function(n){let s=this;return Object.create(this.builds([n.title||"",n.steps.map((e,t)=>"　 "+ ++t+". "+e.desc).join("\n"),0,0,"I",1],{progress:{max:100,showMinMax:!!n.show_min_max}}),{act:{value:function(){let e=new Promise(e=>{this.on("positive",()=>{global._$_dialog_flow_interrupted=!0}),"function"==typeof n.onStart&&n.onStart(n.initial_value,this),e(n.initial_value)});return n.steps.forEach((o,i)=>{e=e.then(t=>{if(global._$_dialog_flow_interrupted)throw Error(s._text.user_interrupted);var e=e=>(this.setProgress(100),a.call(this,i+1),o.onSuccess&&o.onSuccess(t),e);this.setProgress(0),function(e){let o=e.toString(),t=s.getContentText(this);s.setContentText(this,t.replace(/^(. )(\d)(?=\.)/gm,(e,t,r)=>(r===o?"▶ ":t)+r))}.call(this,i+1);let r=o.action(t,this);return r instanceof Promise?(r=r.then(e),r):e(r)},o.onFailure)}),e=e.then(e=>{if(global._$_dialog_flow_interrupted)throw Error(s._text.user_interrupted);s.setProgressColorTheme(this,"finish"),a.call(this,"all"),this.removeAllListeners("positive"),this.setActionButton("positive",s._text._btn.F),this.on("positive",e=>e.dismiss());var t=n.success_title;t&&s.setTitleText(this,t);t=n.success_content;t&&s.appendContentText(this,"\n\n"+t),delete global._$_dialog_flow_interrupted,"function"==typeof n.onSuccess&&n.onSuccess(e,this)}),e.catch(e=>{s.setProgressColorTheme(this,"error"),this.removeAllListeners("positive"),this.setActionButton("positive",s._text._btn[n.on_interrupt_btn_text||"B"]),this.on("positive",e=>e.dismiss()),s.alertContent(this,e,"append"),delete global._$_dialog_flow_interrupted,"function"==typeof n.onFailure&&n.onFailure(e,this)}),this.isShowing()||this.show(),this},enumerable:!0},setStepDesc:{value:function(e,t,r){if(e<1)throw Error("step_num is less than 1");if(e>=n.steps.length)throw Error("step_num must be less than steps length");e=e.toString();let o=this.getContentView(),i=o.getText().toString();e=n.steps[e-1].desc;return i.match(e)&&(t=(r?e:"")+(t||""),o.setText(i.replace(e,t))),this},enumerable:!0},setProgressData:{value:function(e){return"object"==typeof e&&(e=e.processed/e.total*100||0,this.setProgress(Math.min(Math.max(0,e),100))),this},enumerable:!0},setFailureData:{value:function(e){return this.setActionButton("positive",s._text._btn.B),this.removeAllListeners("positive"),this.on("positive",e=>e.dismiss()),s.alertContent(this,e,"append"),this},enumerable:!0}});function a(e){var o="all"!==e&&e?e:1/0;let t=s.getContentText(this);s.setContentText(this,t.replace(/^(. )(\d)(?=\.)/gm,(e,t,r)=>(r<=o?"✔ ":t)+r))}},buildProgress:function(n){var r=this;return Object.create(this.builds([n.title||"",n.content||n.desc||"",0,0,"I",1],{progress:{max:100,showMinMax:!!n.show_min_max}}),{act:{value:function(){return Promise.resolve(n.initial_value).then(e=>("function"==typeof n.onStart&&n.onStart(n.initial_value,this),e)).then(e=>{if(this.on("positive",()=>{global._$_dialog_flow_interrupted=!0}),global._$_dialog_flow_interrupted)throw Error(r._text.user_interrupted);return n.action(e,this)}).then(e=>{if(global._$_dialog_flow_interrupted)throw Error(r._text.user_interrupted);r.setProgressColorTheme(this,"finish"),this.setProgress(100),this.removeAllListeners("positive"),this.setActionButton("positive",r._text._btn.F),this.on("positive",e=>e.dismiss());var t=n.success_title;t&&r.setTitleText(this,t);t=n.success_content;t&&r.appendContentText(this,"\n\n"+t),delete global._$_dialog_flow_interrupted,"function"==typeof n.onSuccess&&n.onSuccess(e,this)}).catch(e=>{r.setProgressColorTheme(this,"error"),this.removeAllListeners("positive"),this.setActionButton("positive",r._text._btn[n.on_interrupt_btn_text||"B"]),this.on("positive",e=>e.dismiss()),r.alertContent(this,e,"append"),delete global._$_dialog_flow_interrupted,"function"==typeof n.onFailure&&n.onFailure(e,this)}),this.isShowing()||this.show(),this},enumerable:!0},setStepDesc:{value:function(e,t){let r=this.getContentView(),o=r.getText().toString();var i=n.content||"";return o.match(i)&&(e=(t?i:"")+(e||""),r.setText(o.replace(i,e))),this},enumerable:!0},setProgressData:{value:function(e){return this.setProgress(e.processed/e.total*100),this},enumerable:!0},setFailureData:{value:function(e){return this.setActionButton("positive",r._text._btn.B),this.on("positive",e=>e.dismiss()),r.alertContent(this,e,"append"),this},enumerable:!0}})},setProgressColorTheme:function(e,t){let r=t;if(!Array.isArray(r))if("string"==typeof r)r=this._colors.progress[t]||[r];else{if("number"!=typeof r)throw Error("Unknown colors type for $dialogsx.setProgressColorTheme()");r=[r]}var[o,i,t]=r;o&&this.setProgressTintList(e,o),i&&this.setProgressBackgroundTintList(e,i),t&&this.setActionButtonColor(e,"positive",t)},setActionButtonColor:function(e,t,r){t=com.afollestad.materialdialogs.DialogAction[t.toUpperCase()],r=android.content.res.ColorStateList.valueOf($colorsx.toInt(this._colors.wrap(r,"button")));e.getActionButton(t).setTextColor(r)},setProgressTintList:function(e,t){e.getProgressBar().setProgressTintList(android.content.res.ColorStateList.valueOf($colorsx.toInt(this._colors.wrap(t,"progress"))))},setProgressBackgroundTintList:function(e,t){e.getProgressBar().setProgressBackgroundTintList(android.content.res.ColorStateList.valueOf($colorsx.toInt(t)))},clearProgressNumberFormat:function(e){ui.run(()=>e.setProgressNumberFormat(""))},dismiss:function(e){(Array.isArray(e)?e:[].slice.call(arguments)).forEach(e=>{"object"==typeof e&&e.dismiss&&e.dismiss()})},disableBack:function(e,r){return e.setOnKeyListener({onKey:function(e,t){return"function"==typeof r&&r(),t===android.view.KeyEvent.KEYCODE_BACK}}),e},setContentText:function(e,t){ui.run(()=>{e&&e.getContentView().setText(t?t.toString():"")})},setProgressNumberFormat:function(e,t,r){ui.run(()=>e.setProgressNumberFormat(java.lang.String.format(t,r)))}};function _deployVersion(e){$appx.deployProject(e,{onSuccess:function(e,t){let r=e.target_path;e=$filesx.getScriptDirPath();t.removeAllListeners("positive"),t.setActionButton("positive","下一步"),$dialogsx.appendContentText(t,"\n\n项目部署路径:\n."+r.slice(e.length+r.search(e))),t.on("positive",e=>{function t(){$dialogsx.builds(["项目使用声明",["代码完全公开","杜绝恶意代码","项目永久免费","欢迎提议反馈"].map(e=>"· "+e).join("\n"),0,0,["F","finish"],1,"立即运行项目"]).on("positive",e=>{e.dismiss(),e.isPromptCheckBoxChecked()&&(e=context.getPackageName(),app.startActivity({packageName:e,className:e+".external.open.RunIntentActivity",data:"file://"+r+"/ant-forest-launcher.js"})),exit()}).show()}e.dismiss(),engines.myEngine().source.name.match(/^Ant.Forest.+er/)?dialogs.build({title:"新项目使用提示",content:'可能需要在Auto.js程序主页下拉刷新才能看到新项目\n新项目默认是以"Ant-Forest-003"命名的蓝色目录 进入目录可运行新项目\n对于当前目录下的旧项目文件 若无保留需要 可全部移除\n移除时需谨慎 避免误删可能存在的项目以外的重要文件',positive:"下一步",autoDismiss:!1,canceledOnTouchOutside:!1}).on("positive",e=>{e.dismiss(),t()}).show():t()})}},{on_interrupt_btn_text:"X",success_title:"项目部署完成"})}function _waitForAction(e,t,r){let a=("function"==typeof getSelector?getSelector:function(){let e=selector();return e.__proto__={pickup:function(e,t){if(null==e)return null;if(void 0!==t&&"w"!==t&&"widget"!==t)throw Error("getSelectorRaw()返回对象的pickup方法不支持结果筛选类型");if(2<arguments.length)throw Error("getSelectorRaw()返回对象的pickup方法不支持复杂参数传入");if("string"==typeof e)return desc(e).findOnce()||text(e).findOnce();if(e instanceof RegExp)return descMatches(e).findOnce()||textMatches(e).findOnce();if(e instanceof com.stardust.automator.UiObject)return e;if(e instanceof com.stardust.autojs.core.accessibility.UiSelector)return e.findOnce();throw Error("getSelectorRaw()返回对象的pickup方法不支持当前传入的选择体")}},e})(),o=t="number"!=typeof t?Number(t)||1e4:t;(o<=0||!isFinite(o)||isNaN(o)||100<o)&&(o=1/0);let i=1/0;100<t&&(i=t);var n=r||200;n>=i&&(o=1);for(var s=Date.now();!function r(e){if("function"==typeof e)return e();if(!Array.isArray(e))return a.pickup(e);if(null==e)return!1;var o=e=>"string"==typeof e&&e.match(/^;(a(ll|nd))$/);var i=e=>"string"==typeof e&&e.match(/^;(o(r|ne))$/);let n=e.slice();let s=";all";var e=n[n.length-1];(o(e)||i(e))&&(s=n.pop());for(let e=0,t=n.length;e<t;e+=1){if(o(s)&&!r(n[e]))return!1;if(i(s)&&r(n[e]))return!0}return o(s)}(e)&&--o;){if(Date.now()-s>i)return!1;sleep(n)}return 0<o}$dialogsx.builds(["项目部署","欢迎使用蚂蚁森林项目部署工具\n此工具用于 v2.0.0 以上版本的项目部署",["了解项目","hint"],["退出","caution"],["开始部署","attraction"],1]).on("neutral",()=>{$dialogsx.linkify($dialogsx.builds(["关于项目","- 功能简介 -\n"+["自动收取好友能量","自动收取/监测自己能量","收取结果统计/展示","控制台消息提示","自动解锁屏幕","定时任务与循环监测","多任务自动排队","脚本运行安全","事件监测与处理","黑名单机制","项目管理","账户功能","统计功能","图形化配置工具"].map(e=>"· "+e).join("\n")+"\n\n- 项目作者 -\n· SuperMonster003\n\n- 项目链接 -\n· https://github.com/SuperMonster003/Ant-Forest",0,0,"返回",1]).on("positive",e=>e.dismiss()).show(),"WEB_URLS")}).on("negative",e=>{e.dismiss(),exit()}).on("positive",e=>{e.dismiss(),$appx.getProjectReleases({min_version_name:"v2.0.1",show_progress_dialog:!0},function(r){r.length||exit();var e=r[0];let t=e.version_name;$dialogsx.builds(["选择项目版本","选择希望部署的项目版本",["版本历史","hint"],["X","warn"],"下一步",1],{items:["最新版本 ("+t+")","其他版本"],itemsSelectMode:"single",itemsSelectedIndex:0}).on("neutral",()=>{$appx.getProjectChangelog(t.match(/v(\d+)/)[1],{is_show_dialog:!0})}).on("negative",t=>{$dialogsx.builds(["提示","项目部署尚未完成\n确定要退出吗",0,"B",["确定退出","caution"],1]).on("negative",e=>{e.dismiss()}).on("positive",e=>{e.dismiss(),t.dismiss(),exit()}).show()}).on("positive",t=>{t.dismiss(),0===t.getSelectedIndex()?$threadsx.start(function(){_deployVersion(e)}):$dialogsx.builds(["选择其他项目版本","",0,"上一步","下一步",1],{items:r.slice(1).map(e=>e.version_name),itemsSelectMode:"single",itemsSelectedIndex:0}).on("negative",e=>{e.dismiss(),t.show()}).on("positive",e=>{e.dismiss(),$threadsx.start(function(){_deployVersion(r[e.getSelectedIndex()+1])})}).show()}).show()})}).show();